# TPS Testing

For running all the tests, enter this directory and type:
```
./run test-all.sh
```

A large portion of tests are generated by capturing the behavior of the code
 (when it seems to work correctly) with the purpose of regression tests.
These are called "captured" tests.
In order to regenerate those tests, run:
```
./run capture-all.sh
```

You can use `run.bat` instead of `./run` in windows.
Though, the tool runs slower in windows.

By default, some details about the process of running/capturing the tests is printed.
Adding the option `-q` or `--quiet` after `run` prevents writing these information.
Examples:
```
./run -q test-all.sh
./run --quiet capture-all.sh
```


## Command `expect_exec`

A major tool in the tests is the command `expect_exec`,
 which runs a command and verifies its expected behavior.
The command is executed in `sandbox/stage`.
```
expect_exec [options] command [command arguments...]
```

Options:
* `-d <a-dir>`:
 Sets the current working directory of the command (relative to the stage directory).
 If not specified, it checks the environment variable `EXEC_WORKING_DIRECTORY`
  (which can be set/unset respectively with `set_exec_cwd` and `unset_exec_cwd`).
 If the environment variable is not specified either,
  then the command is run in the root of the stage directory.
* `-abs`
 Makes the command path absolute.
 Default: true for and only for commands ending with `.sh` and `.py`.
 Files ending with `.sh` are automatically run by `bash`.
 Files ending with `.py` are automatically run by `${PYTHON}`/`python3`/`python`.
* `-i <a-file>`:
 Specifies the standard input of the command.
 If not specified, the input will be `/dev/null`.
* `-r <an-integer>`, `-rnz`, `-rignore`:
 The first version specifies the expected exit code of the command execution.
 The second version specifies the expected exit code to be any nonzero value.
 The third version specifies that the exit code is ignored.
 If not specified, zero exit code is expected.
* `-oignore`:
 Ignore the standard output of the command execution.
* `-oempty`:
 Expect the standard output of the command execution to be empty.
* `-o <a-file>`:
 Expect the standard output of the command execution to be exactly the same as the given file.
* `-oh <a-text-parameter>`, `-oH <a-text-parameter>`:
 Expect the standard output of the command execution to be exactly the same as the given parameter.
 The output must end with the new-line character if `-oh` is used,
 and it must not end with the new-line character if `-oH` is used.
* `-oh2 <line-1> <line-2>`, `-oH2 <line-1> <line-2>`:
 Similar to `-oh`/`-oH`, but the output should have two lines as specified.
* `-oh<an-integer-k> <line-1> <line-2> ... <line-k>`, `-oH<an-integer-k> <line-1> <line-2> ... <line-k>`:
 A generalization of `-oh2`/`-oH2`, but the output should have $k$ lines as specified.
* `-eignore`, `-eempty`, `-e <a-file>`, `-eh <a-text-parameter>`, `-eH <a-text-parameter>`, `-eh<an-integer-k> <line-1> <line-2> ... <line-k>`, `-eH<an-integer-k> <line-1> <line-2> ... <line-k>`:
 Similar to the `-o...` options, but for the standard error of the command execution.


## Capturing commands
### `capture_exec`
The major tool in capturing the tests is the command `capture_exec`,
 which runs a command, captures its behavior, and generates an `expect_exec` command.
The command is executed in `sandbox/stage`.
```
capture_exec &lt;captured-test-key&gt; [options] command [command arguments...]
```

The parameter `<captured-test-key>` is a unique string specifying the captured test.
The options are similar to `expect_exec`.
The expectation options of the generated `expect_exec` command are specified by `capture_exec`
 unless explicitly specified as an option for `capture_exec`.

### `capture_run`
A useful tool in capturing scripts is the command `capture_run`,
 which runs a command, and also generates the same command as a command to be run in the captured tests.
```
capture_run command [command arguments...]
```


## Implementation notes

The prefix `_TT_` in names of variables and functions stands for `TPS TESTING`.
This prefix is added to prevent name clashes between the test codes and main codes.
